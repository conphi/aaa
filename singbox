wget https://github.com/SagerNet/sing-box/releases/download/v1.12.14/sing-box-1.12.14-linux-amd64.tar.gz
tar -zxvf sing-box-1.12.14-linux-amd64.tar.gz
cd sing-box-1.12.14-linux-amd64/
sing-box run -c server.json
sing-box run -c client.json

################ vless + reality ##########################
### 需在“服务器”端运行脚本 setup_singbox.sh 必须 和 sing-box 在同一个文件夹 #########
#!/bin/bash

# 基础设置
IP=$(curl -s ifconfig.me)
UUID=$(./sing-box generate uuid)
KEYS=$(./sing-box generate reality-keypair)
PRIVATE_KEY=$(echo "$KEYS" | grep "PrivateKey" | awk '{print $2}')
PUBLIC_KEY=$(echo "$KEYS" | grep "PublicKey" | awk '{print $2}')
SHORT_ID=$(./sing-box generate rand --hex 8)

# 生成服务端配置文件
cat <<EOF > server.json
{
  "log": { "level": "info" },
  "inbounds": [{
    "type": "vless",
    "tag": "vless-in",
    "listen": "::",
    "listen_port": 443,
    "users": [{ "uuid": "$UUID", "flow": "xtls-rprx-vision" }],
    "tls": {
      "enabled": true,
      "server_name": "www.microsoft.com",
      "reality": {
        "enabled": true,
        "handshake": { "server": "www.microsoft.com", "server_port": 443 },
        "private_key": "$PRIVATE_KEY",
        "short_id": ["$SHORT_ID"]
      }
    }
  }],
  "outbounds": [{ "type": "direct", "tag": "direct" }]
}
EOF

# 生成客户端配置文件
cat <<EOF > client.json
{
  "log": { "level": "info" },
  "dns": {
    "servers": [
      { "tag": "dns_proxy", "address": "https://8.8.8.8/dns-query", "detour": "proxy" },
      { "tag": "dns_direct", "address": "223.5.5.5", "detour": "direct" }
    ],
    "strategy": "ipv4_only"
  },
  "inbounds": [{
    "type": "tun",
    "tag": "tun-in",
    "address": [ "172.19.0.1/30" ],
    "auto_route": true,
    "strict_route": true,
    "sniff": true
  }],
  "outbounds": [{
    "type": "vless",
    "tag": "proxy",
    "server": "$IP",
    "server_port": 443,
    "uuid": "$UUID",
    "packet_encoding": "xudp",
    "flow": "xtls-rprx-vision",
    "tls": {
      "enabled": true,
      "server_name": "www.microsoft.com",
      "utls": { "enabled": true, "fingerprint": "chrome" },
      "reality": { "enabled": true, "public_key": "$PUBLIC_KEY", "short_id": "$SHORT_ID" }
    }
  }, { "type": "direct", "tag": "direct" }],
  "route": {
    "rules": [ { "protocol": "dns", "action": "hijack-dns" } ],
    "auto_detect_interface": true
  }
}
EOF

echo "--------------------------------------------------"
echo "全部完成！"
echo "服务端文件已生成: server.json"
echo "客户端文件已生成: client.json (请下载到本地使用)"
echo "--------------------------------------------------"
##############################################################
